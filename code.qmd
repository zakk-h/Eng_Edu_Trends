---
title: "Investigating Factors Influencing Academic Achievement in English Towns"
author: "Zakk Heile & Julia Healey-Parera"
format: pdf
---

```{r}
library(MASS)
library(tidyverse)
library(broom)
library(Stat2Data)
library(pROC)
library(yardstick)
library(janitor)
library(here)
library(fs)
library(withr)
library(lmtest)
library(tidytuesday)

tuesdata <- tidytuesdayR::tt_load('2024-01-23')
english_education <- tuesdata$english_education
```

```{r}
#Combining regions where it makes sense geographically
lambda <- bc$x[which.max(bc$y)]
english_education <- english_education |>
  mutate(rgn11nm = as.charaacter(rgn11nm),
         rgn11nm_combined = case_when(rgn11nm %in% c("South East", "South West") ~ "South",
                                      rgn11nm == "North East" ~ "North East",
                                      rgn11n == "North West" ~ "North West",
                                      . ~ "Other"),
         rgn11nm_combined = factor(rgn11nm_combined),
         rgn11nm_combined = relevel(rgn11nm_combined, ref = 'South'))

#english_education$population_2011_bc <- (english_education$population_2011^lambda - 1) / lambda

# level4qual_residents35_64_2011
# activity_at_age_19_full_time_higher_education
# activity_at_age_19_appprenticeships

#boxcox transformation
#Preparing boxcox object
lambda <- bc$x[which.max(bc$y)]

bc <- boxcox(lm(highest_level_qualification_achieved_b_age_22_average_score ~ population_2011, data = english_education))

english_education |>
  mutate(population_2011_bc = population_2011^(lambda - 1) / lambda)

#Final model that includes an interaction term
m1 <- lm(
  highest_level_qualification_achieved_b_age_22_average_score	~ 
    level4qual_residents35_64_2011*level_3_at_age_18 +
    activity_at_age_19_full_time_higher_education +
    level4qual_residents35_64_2011 +
    rgn11nm_combined + 
    level_3_at_age_18	+ 
    key_stage_4_attainment_school_year_2012_to_2013, 
  data = english_education
  )

m1_stats <- tidy(m1)
```

```{r}


#transforming to log odds
#english_education <- english_education %>%
#  mutate(log_odds_ks4asy = log(key_stage_4_attainment_school_year_2012_to_2013 / (1 #- key_stage_4_attainment_school_year_2012_to_2013)))

#m1 <- lm(education_score ~ population_2011, data = english_education)

#summary(m1)

#m1 <- lm(education_score ~  factor(size_flag), data = english_education)

#summary(m1)

#better option - population_2011
#m1 <- lm(education_score ~  factor(size_flag)+factor(university_flag)+factor###(job_density_flag)+highest_level_qualification_achieved_b_age_22_average_score+factor(rgn11nm), data = english_education)
#summary(m1)

#english_education <- na.omit(english_education) #complete case analysis for all variables, even those we aren't using. We want R's default complete case analysis, only for those variables we are working with.

#Residual Plot
ggplot(m1, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "darkred") + 
  labs(x = "Fitted (predicted) value", y = "Residual", title = "Linearity looks great except at endpoints, Constant variance looks sufficient") + 
  theme_bw()

m1_aug <- augment(m1)

#QQ Plot
ggplot(m1, aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line() + 
  theme_bw() + 
  labs(x = "Theoretical quantiles", 
       y = "Sample quantiles", title = "Slight deviations but very reasonably normal")

#Our custom method of assessing constant variance - splitting into even intervals, calculating variance of each, and comparing.
quantiles <- quantile(m1_aug$.fitted, probs = seq(0, 1, by = 0.2))

variance_intervals_df <- data.frame(
  interval = character(0), 
  variance = numeric(0))

#Generating individual variance dataframe
for (i in 1:5) {
  subset_data <- m1_aug %>%
    filter(.fitted >= quantiles[i] & .fitted < quantiles[i + 1])
  
  interval_name <- paste(round(quantiles[i], 2), "-", round(quantiles[i + 1], 2), sep="")
  variance_value <- var(subset_data$.resid)
  
  variance_intervals_df <- rbind(variance_intervals_df, 
                           data.frame(interval=interval_name,
                           variance=variance_value))
}
print(variance_intervals_df)

#Formal test for constant variance
bptest_result <- bptest(m1)
print(bptest_result)

#Calculating mean and standard deviation of residuals
resid_mean <- mean(m1_aug$.resid, na.rm = TRUE)
resid_sd <- sd(m1_aug$.resid, na.rm = TRUE)

#Histogram compared to normal distribution
ggplot(m1_aug, aes(x = .resid)) + 
  geom_histogram(aes(y = ..density..), 
                 fill = "deepskyblue", color = "darkblue", bins = 30) + 
  stat_function(fun = dnorm, 
                args = list(mean = resid_mean, sd = resid_sd),
                color = "darkred", lwd = 2) +
  labs(x = "Residual", y = "Density", title = "Symmetric tails and great fit to normal distribution") + 
  theme_bw()


#transforming back
#predicted_log_odds <- predict(m1, type = "response")
#predicted_proportions <- exp(predicted_log_odds) / (1 + exp(predicted_log_odds))
```

```{r}
#| label: Min-max-variable-values

##Finding min and max values taken on by dataset variables

#Education score
min_max_education_score <- english_education |>
  summarise(min_education_score = min(education_score, na.rm = TRUE),
            max_education_score = max(education_score, na.rm = TRUE))

#Population
min_max_population_2011 <- english_education |>
  summarise(min_population_2011 = min(population_2011, na.rm = TRUE),
            max_population_2011 = max(population_2011, na.rm = TRUE))

#Highest qualification
min_max_highest_qualification <- english_education |>
  summarise(
    min_highest_qualification = min(
      highest_level_qualification_achieved_b_age_22_average_score, 
      na.rm = TRUE
      ),
    max_highest_qualification = max(
      highest_level_qualification_achieved_b_age_22_average_score, 
      na.rm = TRUE
      )
    )

#Prop. of key stage 4 cohorts at level 3 at age 18
min_max_level_3_age_18 <- english_education |>
  summarise(min_level_3_age_18 = min(level_3_at_age_18, na.rm = TRUE),
            max_level_3_age_18 = max(level_3_at_age_18, na.rm = TRUE))

#Prop. of key stage 4 cohort with earnings above 10K at age 19
min_max_activity_age_19 <- english_education |>
  summarise(
    min_activity_age_19 = min(
      activity_at_age_19_employment_with_earnings_above_10_000,
      na.rm = TRUE
      ),
    max_activity_age_19 = max(
      activity_at_age_19_employment_with_earnings_above_10_000, 
      na.rm = TRUE
      )
    )

#Prop. of students achieving 5 GSCE or more in school year 2012-2013
min_max_key_stage_4 <- english_education |>
  summarise(
    min_key_stage_4 = min(
      key_stage_4_attainment_school_year_2012_to_2013, 
      na.rm = TRUE
      ),
    max_key_stage_4 = max(
      key_stage_4_attainment_school_year_2012_to_2013, 
      na.rm = TRUE
      )
    )

#Combining minimums and maximums of all variables
min_max_df <- bind_rows(
  min_max_education_score,
  min_max_population_2011,
  min_max_highest_qualification,
  min_max_level_3_age_18,
  min_max_activity_age_19,
  min_max_key_stage_4
)

print(min_max_df)
```

```{r}

#Creating dataframe for pair plot
edu_pairs <- english_education |> 
  select(
    activity_at_age_19_full_time_higher_education,
    highest_level_qualification_achieved_b_age_22_average_score,
    level_3_at_age_18, 
    key_stage_4_attainment_school_year_2012_to_2013) |> 
  rename(fulltime_higher_ed = activity_at_age_19_full_time_higher_education, 
         level_3 = level_3_at_age_18,
         attainment = key_stage_4_attainment_school_year_2012_to_2013,
         qualification = highest_level_qualification_achieved_b_age_22_average_score)

#Creating pair plot
pairs(edu_pairs[, 1:4], main = "Pairs Plot of Continuous Variables - No Significant Multicollinearity", col = "#012169")

#Creating bar graph of variable distribution
ggplot(english_education, aes(x = factor(rgn11nm_combined))) +
<<<<<<< HEAD
  geom_bar(fill = "#012169") +
  labs(x = "Region (rgn11nm_combined)", y = "Count", title = "Relative Distributions of New Regions") +
  theme_bw() 
=======
  geom_bar() +
  labs(x = "Region (rgn11nm_combined)", y = "Count", title = "Relative Distributions of New Regions")
>>>>>>> 9fea75c36caca55a14615a85b7841f8ac1ffc8b7
  
```
